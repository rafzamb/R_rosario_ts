---
title: "Sknifedatar: R-Rosario"
description: |
  Ejemplo automagic tabs para predicciones de modelos.
author:
  - first_name: "Rafael"
    last_name: "Zambrano"
    url: https://rafael-zambrano-blog-ds.netlify.app/
  - first_name: "Karina"
    last_name: "Bartolom茅"
    url: https://karbartolome-blog.netlify.app/
    affiliation: R-Rosario
    affiliation_url: https://renrosario.rbind.io/
date: 10-06-2021
output:
  distill::distill_article:
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, 
                      comment=FALSE)
```

#  Librerias

```{r}
library(sknifedatar)
library(tidymodels)
library(tidyverse)
library(probably)
library(modeldata)
library(skimr)
library(rmarkdown)
library(gtsummary)
library(gt)
```

#  Datos

Datos de riesgo crediticio

```{r}
data(credit_data)

credit_data <- credit_data %>% 
  drop_na() %>% 
  mutate(Status = fct_relevel(Status, "bad"))

credit_data %>% head() %>% gt()
```

#  An谩lisis exploratorio

```{r}
skim(credit_data)
```

#  Modelado

Partici贸n en train y test:

```{r}
set.seed(42)
splits <- initial_split(credit_data)
```

Definici贸n del workflow: 

```{r}
#Modelo
modelo <- logistic_reg() 

#Receta
receta <- recipe(Status ~ ., data =  training(splits)) %>% 
  
  step_normalize(all_numeric_predictors()) %>% 
  
  step_dummy(all_nominal_predictors())

#workflow
workflow_credito <- workflow() %>% 
  
  add_model(modelo) %>% 
  
  add_recipe(receta)
```

Predicciones: 

```{r}
predicciones <- workflow_credito %>% 
  
  fit( training(splits)) %>% 
  
  augment( testing(splits))


predicciones %>% head() %>% gt()
```

#  Evaluaci贸n del modelo

Matriz de confusi贸n:

```{r}
predicciones %>% 
  
  conf_mat(Status, .pred_class) %>% 
  
  autoplot(type = "heatmap")
```

Matriz de confusi贸n cambiando el punto de corte: 

```{r}
predicciones %>% 
  
  mutate(.pred_class = make_two_class_pred(.pred_bad,
                                           levels(Status), 
                                           threshold = 0.7)) %>% 
  
  select(Status, .pred_class) %>% 
  
  conf_mat(Status, .pred_class) %>% 
  
  autoplot(type = "heatmap")
```

Generaci贸n de distintos puntos de corte: se obtienen diversos puntos de corte seg煤n las probabilidades predichas. Estos ser谩n los puntos de corte a analizar en la matriz de confusi贸n. 

```{r}
thresholds_cuts <- predicciones$.pred_bad %>% 
  quantile(seq(0,1,0.1)) %>% 
  round(2)

thresholds_cuts

thresholds_cuts %>% plot()
```

Tibble con distintos puntos de corte y matriz de confusi贸n asociada a cada uno de ellos. 

```{r}
thresholds_tibble <- tibble(thresholds = thresholds_cuts) %>%
  
  mutate(matrices_plot = map(thresholds, ~ predicciones %>%
                               
                   mutate(.pred_class = make_two_class_pred(.pred_bad,
                                                            levels(Status),
                                                            threshold = .x)) %>% 
                               
                               select(Status, .pred_class) %>% 
                               
                               conf_mat(Status, .pred_class) %>% 
                               
                               autoplot(type = "heatmap")))

thresholds_tibble %>% paged_table()
```

```{r}
thresholds_tibble$matrices_plot[[1]]
```

#  Automagic tabs 

```{r ,echo=FALSE}
xaringanExtra::use_panelset()
```

`r automagic_tabs(input_data = thresholds_tibble, panel_name = "thresholds", .output = "matrices_plot")`
