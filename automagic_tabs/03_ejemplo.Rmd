---
title: "Sknifedatar: R-Rosario"
description: |
  Ejemplo automagic tabs2 para an치lisis de modelos.
author:
  - first_name: "Rafael"
    last_name: "Zambrano"
    url: https://rafael-zambrano-blog-ds.netlify.app/
  - first_name: "Karina"
    last_name: "Bartolom칠"
    url: https://karbartolome-blog.netlify.app/
    affiliation: R-Rosario
    affiliation_url: https://renrosario.rbind.io/
date: 10-06-2021
output:
  distill::distill_article:
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE, 
                      comment=FALSE)
```

# 游댳 Librerias

```{r}
library(sknifedatar)
library(tidymodels)
library(tidyverse)
library(modeldata)
library(rmarkdown)
library(gtsummary)
library(performance)
library(see)
```

# 游댳Datos

Datos de riesgo crediticio

```{r}
data(credit_data)

credit_data <- credit_data %>% 
  drop_na() %>%
  select(- c(Marital, Job, Records, Seniority, Expenses, Income, Amount)) %>% 
  mutate(Status = fct_relevel(Status, "bad"))
```

# 游댳 Dataset anidado

Se genera un dataset anidado, seg칰n la variable Home (tipo de propietario)

```{r}
dataset <- credit_data %>% nest(datos = -Home)

#dataset
```

```{r}
dataset <- dataset %>% filter(Home != "ignore")
```

```{r}
# dataset$datos[[1]] %>% head()
```

```{r}
set.seed(42)
dataset$datos[[2]] <- dataset$datos[[2]] %>% 
                            mutate(Time = Age+runif(nrow(dataset$datos[[2]]), min=5, max=20))
```

```{r}
set.seed(42)
dataset$datos[[3]] <- dataset$datos[[3]] %>% 
                            mutate(Assets = Price^2)
```



# 游댳 Workflows

```{r}
#Modelo
modelo <- logistic_reg() 

#Receta
receta <- recipe(Status ~ ., data = dataset$datos[[1]]) %>% 
  
  step_normalize(all_numeric_predictors()) %>% 
  
  step_dummy(all_nominal_predictors())

#workflow
workflow_credito <- workflow() %>% 
  
  add_model(modelo) %>% 
  
  add_recipe(receta)
```

# 游댳 Ajuste de modelos

Se ajusta el workflow para cada una de las series en el dataset anidado. Un modelo para cada tipo de propiedad.

```{r}
output_final <- dataset %>% 
  
  mutate(modelo = map(datos, ~ workflow_credito %>% 
                        fit(.x) %>% 
                        extract_fit_engine()))
```

```{r}
#output_final
```

```{r}
#output_final$modelo[[1]]
```

# 游댳 Generaci칩n de gr치ficos

Se generan gr치ficos para evaluar los modelos. En este caso, se utiliza la funci칩n **check_model()** del paquete **{performance}** 游닍 para evaluar el fctor de inflaci칩n de la varianza (o VIF por sus siglas en ingl칠s).

```{r}
output_final <- output_final %>% 
  
  mutate(graficos = map(modelo, ~ check_model(.x, check = "vif")))
```

```{r}
#output_final
```

```{r}
#output_final$graficos[[1]]
```


# 游댳 Generaci칩n de tablas

Se utiliza la funci칩n **tbl_regression()** del paquete **{gtsummary}** 游닍 para generar las tablas de res칰men de cada uno de los modelos.

```{r}
output_final <- output_final %>% 
  
mutate(tabla_modelo = map(modelo, ~ tbl_regression(.x, exponentiate = TRUE) %>% 
                         bold_p(t = 0.15) %>%
                         bold_labels() %>% 
                         as_gt() %>%
                         gt::tab_source_note(gt::md("**Fuente: R-Rosario**"))))
```

```{r}
#output_final
```

```{r}
#output_final$tabla_modelo[[1]]
```


# 游댳 automagic_tabs2

La funci칩n **automagic_tabs2()** del paquete **{sknifedatar}** 游닍 permite generar tabs incluyendo 2 objetos de un dataframe. En este caso, se incluyen los gr치ficos y las tablas generados.

```{r ,echo=FALSE}
xaringanExtra::use_panelset()
```

`r automagic_tabs2(input_data = output_final, panel_name = Home, graficos, tabla_modelo)`